{% extends "layout.html" %}
{% block title %}{{ symbol }} - Ticker Details - StockStreaks{% endblock %}

{% block head_extra %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="ticker-detail-page"> <section class="ticker-detail-header card"> <div class="app-logo">
             <a href="{{ url_for('home') }}">Stock<span class="streaks-accent">Streaks</span></a> </div>
        <div class="ticker-info" style="text-align:right;"> <h1 class="symbol">{{ symbol }}</h1> {% if ticker %}
            <p class="price {% if ticker.dailyChangePercent.startswith('+') %}text-positive{% elif ticker.dailyChangePercent.startswith('-') %}text-negative{% else %}text-neutral{% endif %}">
                {{ ticker.currentPrice }} ({{ ticker.dailyChange }}, {{ ticker.dailyChangePercent }}) </p>
            <p class="last-updated">Last Updated: {{ ticker.lastUpdated }}</p> {% else %}
            <p>Ticker data not available.</p>
            {% endif %}
        </div>
    </section>

    {% if ticker %}
    <section class="summary-cards-section"> <div class="summary-cards-grid">
            <div class="summary-card card {% if ticker.currentStreak.type == 'Win' %}bg-positive-faded{% elif ticker.currentStreak.type == 'Loss' %}bg-negative-faded{% endif %}">
                <h3 class="card-title">Current Streak</h3> <p class="value {% if ticker.currentStreak.type == 'Win' %}text-positive{% elif ticker.currentStreak.type == 'Loss' %}text-negative{% endif %}">{{ ticker.currentStreak.type }} {{ ticker.currentStreak.duration }} Days</p> <p class="sub-detail">Total: {{ ticker.currentStreak.priceChange }} ({{ ticker.currentStreak.percentChange }})</p> </div>
            <div class="summary-card card">
                <h3 class="card-title">Longest Winning Streak</h3> <p class="value text-positive">{{ ticker.longestWinStreak.duration }} Days</p> <p class="sub-detail">{{ ticker.longestWinStreak.dateRange }}</p> </div>
            <div class="summary-card card">
                <h3 class="card-title">Longest Losing Streak</h3> <p class="value text-negative">{{ ticker.longestLossStreak.duration }} Days</p> <p class="sub-detail">{{ ticker.longestLossStreak.dateRange }}</p>
            </div>
            <div class="summary-card card">
                <h3 class="card-title">30-Day Volatility</h3> <p class="value text-informational">{{ ticker.volatility30Day }}</p> <p class="sub-detail">Std. Dev of Daily Returns</p> </div>
        </div>
    </section>

    <section class="price-performance-chart-section card"> <h2 class="card-title">Price Performance (Last 30 Days)</h2> <div style="height: 300px; width: 100%;"> <canvas id="pricePerformanceChart"></canvas> </div>
    </section>

    <section class="recent-streak-history-table-section card"> <h2 class="card-title">Recent Streak History</h2>
        <div style="overflow-x: auto;"> <table class="streak-history-table"> <thead>
                    <tr>
                        <th>Type</th> <th>Duration</th> <th>Start Date</th> <th>End Date</th> <th>Total Change</th> </tr>
                </thead>
                <tbody>
                    {% for streak in ticker.recentStreaks %} <tr>
                        <td class="{% if streak.type == 'Win' %}text-positive{% elif streak.type == 'Loss' %}text-negative{% endif %}">{{ streak.type }}</td>
                        <td>{{ streak.duration }}</td>
                        <td>{{ streak.startDate }}</td>
                        <td>{{ streak.endDate }}</td>
                        <td class="{% if streak.totalChange.startswith('+') %}text-positive{% elif streak.totalChange.startswith('-') %}text-negative{% endif %}">{{ streak.totalChange }}</td> </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" style="text-align:center;">No recent streak history available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    {% else %}
    <p>Detailed data for {{ symbol }} could not be loaded.</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts_extra %}
{% if ticker and ticker.priceHistory30Day %}
<script>
    // Prepare data for Chart.js
    // Assumes ticker.priceHistory30Day is a list of objects like {date: "YYYY-MM-DD", close: 123.45}
    // And these are sorted oldest to newest.
    const rawPriceHistory = {{ ticker.priceHistory30Day | tojson | safe }};
    const tickerChartData = {
        labels: rawPriceHistory.map(item => {
            // Format date like "May 01" from "YYYY-MM-DD"
            const date = new Date(item.date + 'T00:00:00'); // Ensure UTC or consistent timezone interpretation
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }),
        prices: rawPriceHistory.map(item => item.close)
    };
</script>
{% endif %}
<script>
    // Add current year to context for footer in layout.html if not done globally
    // This is a fallback, prefer context_processor in app.py
    // document.addEventListener('DOMContentLoaded', function() {
    // const yearSpan = document.querySelector('.global-footer p:first-child');
    // if (yearSpan && yearSpan.textContent.includes('[Current Year]')) {
    //    yearSpan.textContent = yearSpan.textContent.replace('[Current Year]', new Date().getFullYear());
    // }
    // });
</script>
{% endblock %}
